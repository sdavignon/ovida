(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[260],{6757:function(e,t,n){Promise.resolve().then(n.bind(n,3929))},3929:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return l}});var a=n(2334),r=n(3473),i=n(3879),o=n(9660),s=n(7604),c=n.n(s);function l(e){var t;let{params:n}=e,{runId:s}=n,l=(0,r.useRef)(null),u=(0,r.useRef)(null),d=(0,r.useRef)(!1),[h,p]=(0,r.useState)(null),[_,f]=(0,r.useState)(null),[y,g]=(0,r.useState)([]),[m,v]=(0,r.useState)(0),[x,b]=(0,r.useState)("idle"),[j,N]=(0,r.useState)(null),[w,S]=(0,r.useState)(null),[T,C]=(0,r.useState)([]),[k,E]=(0,r.useState)(!1),[I,L]=(0,r.useState)(null),[B,R]=(0,r.useState)(null),[A,U]=(0,r.useState)(!0),H=(0,r.useCallback)(()=>{u.current&&(clearInterval(u.current),u.current=null),S(null)},[]),M=(0,r.useCallback)(async()=>{let e=l.current;if(e)try{await e.play(),E(!1),b("playing")}catch(e){E(!0),b("idle")}},[]),P=(0,r.useCallback)(async e=>{let t="number"==typeof(null==e?void 0:e.index)?"?index=".concat(e.index):"";b("loading"),N(null),H(),d.current=!1,L(null);try{var n,a,r,i,c;let l=await (0,o.S)("/v1/runs/".concat(s,"/next").concat(t),{method:"POST"});if(p(l.beat),f(null!==(i=l.audio)&&void 0!==i?i:null),g(null!==(c=null===(n=l.audio)||void 0===n?void 0:n.urls)&&void 0!==c?c:[]),v(0),R(null),b((null===(r=l.audio)||void 0===r?void 0:null===(a=r.urls)||void 0===a?void 0:a.length)?"playing":"decision"),E(!1),"number"==typeof(null==e?void 0:e.index)&&0===e.index)try{window.localStorage.setItem("ovida-demo:".concat(s),JSON.stringify({beat:l.beat,audio:l.audio}))}catch(e){console.warn("Unable to cache initial beat payload",e)}}catch(e){N(e instanceof Error?e.message:"Unable to load beat"),b("error")}},[s,H]),D=(0,r.useCallback)(function(e){var t;let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!h||!n&&"decision"!==x)return;H(),d.current=!1,S(null);let a=h.choices.find(t=>t.id===e),r=null!==(t=null==a?void 0:a.text)&&void 0!==t?t:e;R(e),L({choiceText:r,auto:n});let i="".concat(h.index,"-").concat(e,"-").concat(Date.now());C(t=>[{id:i,beatIndex:h.index,narration:h.narration,choiceId:e,choiceText:r,auto:n},...t]),b("loading"),g([]),v(0),f(null),N(null),P()},[h,P,x,H]),O=(0,r.useCallback)(()=>{if(d.current||!h)return;d.current=!0,H(),b("decision");let e=h.choices[0];e&&(S(8),u.current=setInterval(()=>{S(t=>null===t?t:t<=1?(D(e.id,!0),0):t-1)},1e3))},[h,D,H]);(0,r.useEffect)(()=>{let e=!1;return(async()=>{H(),d.current=!1,C([]),N(null);{let o=window.localStorage.getItem("ovida-demo:".concat(s));if(o)try{let s=JSON.parse(o);if(!e){var t,n,a,r,i;p(s.beat),f(null!==(r=s.audio)&&void 0!==r?r:null),g(null!==(i=null===(t=s.audio)||void 0===t?void 0:t.urls)&&void 0!==i?i:[]),v(0),R(null),L(null),b((null===(a=s.audio)||void 0===a?void 0:null===(n=a.urls)||void 0===n?void 0:n.length)?"playing":"decision"),E(!1),U(!1)}return}catch(e){console.warn("Failed to load cached demo beat",e)}}await P({index:0}),e||U(!1)})(),()=>{e=!0}},[s,P,H]),(0,r.useEffect)(()=>{"decision"===x&&O()},[x,O]),(0,r.useEffect)(()=>{let e=l.current;if(!e)return;let t=()=>{v(e=>{let t=e+1;return t<y.length?t:(O(),e)})};return e.addEventListener("ended",t),()=>{e.removeEventListener("ended",t)}},[y.length,O]),(0,r.useEffect)(()=>{var e;let t=l.current;if(!t)return;if(!y.length){t.pause(),t.removeAttribute("src");return}let n=null!==(e=y[m])&&void 0!==e?e:y[0];n&&(t.src!==n&&(t.src=n),M())},[y,m,M]),(0,r.useEffect)(()=>()=>{H();let e=l.current;e&&(e.pause(),e.removeAttribute("src"))},[H]);let J=(0,r.useMemo)(()=>{switch(x){case"loading":return"Loading next beat…";case"playing":return"Playing narration";case"decision":return"Awaiting decision";case"error":return"Playback interrupted";default:return"Ready"}},[x]),X=null!==(t=null==h?void 0:h.choices[0])&&void 0!==t?t:null,G=(0,r.useMemo)(()=>y.length?"Segment ".concat(Math.min(m+1,y.length)," of ").concat(y.length):null,[y.length,m]);return(0,a.jsxs)("section",{className:c().player,children:[(0,a.jsxs)("header",{className:c().header,children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:c().eyebrow,children:"Podcast Player"}),(0,a.jsxs)("h2",{children:["Run ",s]})]}),(0,a.jsx)("span",{className:c().badge,children:J})]}),(0,a.jsxs)("div",{className:c().actions,children:[(0,a.jsx)(i.default,{href:"/replay/".concat(s),children:"View Replay"}),(0,a.jsx)(i.default,{href:"/room/".concat(s),children:"Enter Room"})]}),j&&(0,a.jsxs)("div",{className:c().error,children:[(0,a.jsx)("p",{children:j}),"error"===x&&(0,a.jsx)("button",{type:"button",onClick:()=>P(),children:"Retry"})]}),(0,a.jsxs)("div",{className:c().layout,children:[(0,a.jsx)("article",{className:c().beatCard,children:A?(0,a.jsx)("p",{className:c().loading,children:"Preparing the broadcast…"}):h?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:c().beatHeader,children:[(0,a.jsxs)("span",{className:c().beatIndex,children:["Beat ",h.index+1]}),(0,a.jsx)("span",{className:c().audioMeta,children:(null==_?void 0:_.provider)?"".concat(_.provider," • ").concat(_.mime):"No audio for this beat"})]}),(0,a.jsx)("p",{className:c().narration,children:h.narration}),(0,a.jsxs)("div",{className:c().playback,children:[(0,a.jsxs)("div",{className:c().playbackStatus,children:[(0,a.jsx)("span",{className:c().indicator,"aria-hidden":!0}),(0,a.jsx)("span",{children:null!=G?G:J})]}),k&&(0,a.jsx)("button",{type:"button",onClick:M,className:c().retryButton,children:"Resume audio"})]}),"decision"===x&&h.choices.length>0&&(0,a.jsxs)("div",{className:c().choices,children:[(0,a.jsxs)("p",{className:c().prompt,children:["Decide where the story drifts next.",null!==w&&X&&(0,a.jsxs)("span",{className:c().countdown,children:[" ","Auto-selecting ",(0,a.jsx)("strong",{children:X.text})," in ",w,"s"]})]}),(0,a.jsx)("div",{className:c().choiceList,children:h.choices.map(e=>(0,a.jsxs)("button",{type:"button",className:"".concat(c().choiceButton," ").concat(B===e.id?c().choiceSelected:""),onClick:()=>D(e.id),disabled:"decision"!==x,children:[(0,a.jsx)("span",{children:e.text}),(null==X?void 0:X.id)===e.id&&(0,a.jsx)("span",{className:c().choiceDefault,children:"Default"})]},e.id))})]}),I&&"loading"===x&&(0,a.jsxs)("p",{className:c().pendingChoice,children:[I.auto?"Default choice selected:":"You selected:"," ",(0,a.jsx)("strong",{children:I.choiceText}),". Generating the next beat…"]})]}):(0,a.jsx)("p",{className:c().emptyState,children:"No narration yet. Start the Haunted Shore demo to begin the story."})}),(0,a.jsxs)("aside",{className:c().history,children:[(0,a.jsx)("h3",{children:"Recent Decisions"}),0===T.length?(0,a.jsx)("p",{className:c().historyEmpty,children:"Choices will appear here as the stream progresses."}):(0,a.jsx)("ul",{className:c().historyList,children:T.map(e=>(0,a.jsxs)("li",{className:c().historyItem,children:[(0,a.jsxs)("div",{className:c().historyHeader,children:[(0,a.jsxs)("span",{className:c().historyBeat,children:["Beat ",e.beatIndex+1]}),e.auto&&(0,a.jsx)("span",{className:c().historyAuto,children:"Auto"})]}),(0,a.jsx)("p",{className:c().historyNarration,children:e.narration}),(0,a.jsxs)("p",{className:c().historyChoice,children:["Chosen: ",(0,a.jsx)("strong",{children:e.choiceText})]})]},e.id))})]})]}),(0,a.jsx)("audio",{ref:l,preload:"auto",className:c().audio})]})}},9660:function(e,t,n){"use strict";var a;n.d(t,{S:function(){return i}});let r=null!==(a=n(3160).env.NEXT_PUBLIC_API_ORIGIN)&&void 0!==a?a:"http://localhost:4000";async function i(e,t){var n;let a=await fetch("".concat(r).concat(e),{headers:{"Content-Type":"application/json",...null!==(n=null==t?void 0:t.headers)&&void 0!==n?n:{}},...t});if(!a.ok)throw Error(await o(a));if(null==t||!t.skipJson)return await a.json()}async function o(e){try{let t=await e.json();if("string"==typeof(null==t?void 0:t.message))return t.message}catch(e){}return"Request failed with status ".concat(e.status)}},3879:function(e,t,n){"use strict";n.d(t,{default:function(){return r.a}});var a=n(9181),r=n.n(a)},3160:function(e,t,n){"use strict";var a,r;e.exports=(null==(a=n.g.process)?void 0:a.env)&&"object"==typeof(null==(r=n.g.process)?void 0:r.env)?n.g.process:n(8295)},8295:function(e){!function(){var t={229:function(e){var t,n,a,r=e.exports={};function i(){throw Error("setTimeout has not been defined")}function o(){throw Error("clearTimeout has not been defined")}function s(e){if(t===setTimeout)return setTimeout(e,0);if((t===i||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:i}catch(e){t=i}try{n="function"==typeof clearTimeout?clearTimeout:o}catch(e){n=o}}();var c=[],l=!1,u=-1;function d(){l&&a&&(l=!1,a.length?c=a.concat(c):u=-1,c.length&&h())}function h(){if(!l){var e=s(d);l=!0;for(var t=c.length;t;){for(a=c,c=[];++u<t;)a&&a[u].run();u=-1,t=c.length}a=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===o||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function _(){}r.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new p(e,t)),1!==c.length||l||s(h)},p.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=_,r.addListener=_,r.once=_,r.off=_,r.removeListener=_,r.removeAllListeners=_,r.emit=_,r.prependListener=_,r.prependOnceListener=_,r.listeners=function(e){return[]},r.binding=function(e){throw Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw Error("process.chdir is not supported")},r.umask=function(){return 0}}},n={};function a(e){var r=n[e];if(void 0!==r)return r.exports;var i=n[e]={exports:{}},o=!0;try{t[e](i,i.exports,a),o=!1}finally{o&&delete n[e]}return i.exports}a.ab="//";var r=a(229);e.exports=r}()},7604:function(e){e.exports={player:"page_player__jgxvQ",header:"page_header__fjUMv",eyebrow:"page_eyebrow___rxJa",badge:"page_badge__auC8c",actions:"page_actions__0o63J",error:"page_error__TBA2l",layout:"page_layout__b9Udv",beatCard:"page_beatCard__HueyH",beatHeader:"page_beatHeader__e0SMJ",beatIndex:"page_beatIndex__j_LR7",audioMeta:"page_audioMeta__gTrqy",narration:"page_narration__eEIA8",playback:"page_playback__XxZwT",playbackStatus:"page_playbackStatus__H_UUI",indicator:"page_indicator__w9pGx",pulse:"page_pulse__nafJa",retryButton:"page_retryButton__UX3re",choices:"page_choices__2w3_q",prompt:"page_prompt___4M25",countdown:"page_countdown__9Fso7",choiceList:"page_choiceList__WyQCY",choiceButton:"page_choiceButton__uXBIU",choiceSelected:"page_choiceSelected__jooSj",choiceDefault:"page_choiceDefault__OV8GX",pendingChoice:"page_pendingChoice__dyywT",loading:"page_loading__Zj0ug",emptyState:"page_emptyState___XYwo",history:"page_history__U2v4V",historyEmpty:"page_historyEmpty__7znLY",historyList:"page_historyList__9sxZy",historyItem:"page_historyItem__UwT20",historyHeader:"page_historyHeader__RCKKw",historyBeat:"page_historyBeat__GgWfZ",historyAuto:"page_historyAuto__ad_U2",historyNarration:"page_historyNarration__mCtxk",historyChoice:"page_historyChoice__nYw1k",audio:"page_audio__TeNMW"}}},function(e){e.O(0,[442,181,891,381,744],function(){return e(e.s=6757)}),_N_E=e.O()}]);